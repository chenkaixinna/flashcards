<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flashcard App</title>
    <!-- Viewport meta tag for mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --salmon: #F79F77;
            --light-blue: #80BEF5;
            --pale-yellow: #F6D58A;
            --black: #010101;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --soft-teal: #5FD4B1;
            --lavender: #E6E6FA;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            margin: 0;
            background-color: var(--lavender);
            color: var(--black);
            line-height: 1.6;
        }

        nav {
            background-color: var(--light-blue);
            padding: 0.5rem;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        nav button {
            padding: 0.5rem 1rem;
            background-color: var(--white);
            color: var(--light-blue);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        nav button:hover {
            transform: translateY(-2px);
        }

        #content {
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        h2 {
            color: var(--light-blue);
            font-size: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .card-container {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-top: 2rem;
            transition: transform 0.3s ease;
        }

        .card-container:hover {
            transform: translateY(-5px);
        }

        .flashcard-content {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #flashcard-prompt {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 3.5rem;
            text-align: center;
            color: var(--light-blue);
        }

        #flashcard-answer {
            text-align: left;
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .flashcard-item input[type="text"], .flashcard-item textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            border: 2px solid var(--light-blue);
            background-color: var(--white);
            color: var(--black);
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .flashcard-item input[type="text"]:focus, .flashcard-item textarea:focus {
            border-color: var(--salmon);
            outline: none;
        }

        #review-buttons, .card-footer {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            flex-wrap: nowrap;
        }

        #review-buttons button, .card-footer button {
            flex: 1;
            padding: 0.75rem 0.5rem;
            background-color: var(--light-blue);
            color: var(--white);
            border: none;
            cursor: pointer;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        #edit-buttons button {
            padding: 0.75rem 1.5rem;
            background-color: var(--light-blue);
            color: var(--white);
            border: none;
            cursor: pointer;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #review-buttons button:hover, #edit-buttons button:hover, .card-footer button:hover {
            background-color: var(--salmon);
            transform: translateY(-2px);
        }

        #search-bar,
        #flashcard-input,
        #input-page button {
            width: 100%;
            max-width: 600px;
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--light-blue);
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        #flashcard-input {
            min-height: 150px;
            resize: vertical;
        }

        #input-page button {
            background-color: var(--light-blue);
            color: var(--white);
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 600;
        }

        #input-page button:hover {
            background-color: var(--salmon);
        }

        .status-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .status-item {
            background-color: var(--white);
            border-radius: 15px;
            padding: 1.5rem;
            flex: 1 1 calc(50% - 0.75rem);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-5px);
        }

        #show-answers-button, #play-prompt-button {
            margin-top: 1rem;
            background-color: var(--soft-teal);
            color: var(--white);
            margin-bottom: 1.0rem;
            font-size: 0.875rem;
            padding: 0.75rem 1.0rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #show-answers-button:hover, #play-prompt-button:hover {
            background-color: var(--salmon);
            color: var(--white);
            transform: translateY(-2px);
        }

        @media (max-width: 640px) {
            nav button {
                flex: 1 1 calc(50% - 0.25rem);
            }

            .status-item {
                flex: 1 1 100%;
            }

            #search-bar,
            #flashcard-input,
            #input-page button {
                max-width: 100%;
            }
            
            #content {
                padding: 1.5rem;
            }

            h2 {
                font-size: 1.75rem;
            }

            #flashcard-prompt {
                font-size: 2.25rem;
            }

            #flashcard-answer {
                font-size: 1rem;
            }

            #review-buttons, .card-footer {
                gap: 0.25rem;
            }

            #review-buttons button, .card-footer button {
                padding: 0.6rem 0.3rem;
                font-size: 0.8rem;
            }

            #edit-buttons button {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle.js"></script>
    <script>
        // Azure Speech Service Configuration

        const serviceRegion = 'eastasia'; // Replace with your actual region
        const voiceName = 'en-US-JaneNeural'; // Replace with your desired voice
        
        // Verify SpeechSDK is loaded
        console.log('SpeechSDK:', typeof SpeechSDK !== 'undefined' ? 'Loaded' : 'Not Loaded');

        // Your existing JavaScript functions (e.g., playPromptAudio, showAnswers, etc.)
        // Ensure they are defined here or in external scripts included after the SDK
        function parseFlashcards(text) {
            const lines = text.split('\n');
            const cards = [];
            let card = null;
            let content = [];

            lines.forEach(line => {
                if (line.startsWith('- **') && line.includes('#card')) {
                    if (card) {
                        card.answer = content.join('\n').trim();
                        cards.push(card);
                    }
                    card = {
                        prompt: line.match(/- \*\*(.+)\*\* #card/)[1],
                        answer: '',
                        audio: '',
                        image: '',
                        group: groups[cards.length % groups.length],
                        reviewDates: [],
                        nextReviewDate: new Date().toISOString().split('T')[0],
                        rememberedCount: 0,
                        inputDate: new Date().toISOString().split('T')[0]
                    };
                    content = [];
                } else if (line.includes('![Audio](')) {
                    const audioMatch = line.match(/!\[Audio\]\(\.\/assets\/(.+)\)/);
                    if (audioMatch) {
                        card.audio = audioMatch[1];
                    }
                } else if (line.includes('![Image](')) {
                    const imageMatch = line.match(/!\[Image\]\(\.\/assets\/(.+)\)/);
                    if (imageMatch) {
                        card.image = imageMatch[1];
                    }
                } else {
                    content.push(line);
                }
            });

            if (card) {
                card.answer = content.join('\n').trim();
                cards.push(card);
            }

            return cards;
        }
    </script>
</head>
<body>
    <nav>
        <button onclick="showPage('review-page')">Review</button>
        <button onclick="showPage('input-page')">Input</button>
        <button onclick="showPage('status-page')">Status</button>
        <button onclick="showPage('import-export')">Import/Export</button>
        <button id="settings-button" onclick="showPage('settings-page')">Settings</button> <!-- Added ID -->
    </nav>
    <div id="content">
        <!-- Settings Page -->
        <div id="settings-page" style="display: none;">
            <h2>Settings</h2>
            <label for="subscription-key">Azure Subscription Key:</label>
            <input type="text" id="subscription-key" placeholder="Enter your Azure subscription key" />
            
            <label for="service-region">Service Region:</label>
            <input type="text" id="service-region" placeholder="Enter your service region (e.g., eastasia)" />
            
            <br><br>
            <button onclick="saveSettings()">Save Settings</button>
            <button onclick="resetSettings()" style="background-color: #dc3545; margin-left: 10px;">Reset Settings</button> 
        </div>
        <div id="review-page">
            <p>Flashcards to review today: <span id="flashcards-to-review">0</span></p>
            <div class="card-container">
                <div class="flashcard-content">
                    <div id="flashcard-prompt">
                        <!-- Flashcard prompt -->
                    </div>
                        <!-- Show Answers Button -->
                    <button id="show-answers-button" onclick="showAnswers()">Show Answers</button>
                    
                    <!-- Display Prompt Audio Button -->
                    <button id="play-prompt-button" onclick="playPromptAudio()">Display</button> 
                    
                    <!-- Review Buttons (Initially Hidden) -->
                    <div id="review-buttons" class="hidden">
                        <button onclick="reviewChoice('remember')">Remember</button>
                        <button onclick="reviewChoice('forget')">Forget</button>
                        <button onclick="reviewChoice('not_sure')">Not Sure</button>
                    </div>
                    
                    <div id="flashcard-answer" class="hidden">
                        <!-- Answer and media -->
                    </div>
                </div>
            </div>
        </div>
        <!-- Input Page -->
        <!-- Input Page -->
        <div id="input-page" style="display: none;">
            <h2>Input Flashcards</h2>
            
            <!-- Search Bar -->
            <input type="text" id="search-bar" placeholder="Search prompts..." oninput="updateFlashcardList()" style="width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--light-blue); border-radius: 0.25rem;">
            
            <textarea id="flashcard-input" rows="10" cols="80" placeholder="Enter flashcards here..."></textarea>
            <br><br>
            <button onclick="processFlashcards()">Submit Flashcards</button>
            <h3>Flashcards List</h3>
            <div id="flashcard-list">
                <!-- Flashcards for editing will be dynamically inserted here -->
            </div>
        </div>

        <!-- Status Page -->
        <div id="status-page" style="display: none;">
            <h2>Status</h2>
            <div id="status-gallery">
                <!-- Status gallery -->
            </div>
        </div>

        <!-- Import/Export -->
        <!-- Add to Import/Export Page -->
        <div id="import-export" style="display: none;">
            <h2>Import/Export Data</h2>
            <button onclick="exportData()">Export Data</button>
            <br><br>
            <input type="file" id="import-file">
            <button onclick="importData()">Import Data</button>
            <br><br>
            <button onclick="clearCache()">Clear Cache</button>
            <br><br>
            <button onclick="showPage('settings-page')">Change Settings</button> <!-- New Change Settings Button -->
        </div>
    </div>
    <script>
        // Data Structures
        let flashcards = [];
        let currentReviewIndex = -1;
        let audioFiles = {};
        let imageFiles = {};
        const groups = ['A', 'B']; // You can add more groups as needed

        function updateSettingsButtonVisibility() {
            const settingsButton = document.getElementById('settings-button');
            const subscriptionKey = localStorage.getItem('azureSubscriptionKey');
            const serviceRegion = localStorage.getItem('azureServiceRegion');

            if (subscriptionKey && serviceRegion) {
                // Hide the Settings button if settings are already saved
                settingsButton.style.display = 'none';
            } else {
                // Show the Settings button if settings are not saved
                settingsButton.style.display = 'block';
            }
        }
        // Reset Settings Function
        function resetSettings() {
            if (confirm('Are you sure you want to reset your Azure settings?')) {
                localStorage.removeItem('azureSubscriptionKey');
                localStorage.removeItem('azureServiceRegion');
                alert('Azure settings have been reset.');
                
                // Update Settings button visibility
                updateSettingsButtonVisibility();
                
                // Navigate to the Settings page to allow re-entry of credentials
                showPage('settings-page');
            }
        }
        // Save Settings Function
        // Save Settings Function
        function saveSettings() {
            const subscriptionKey = document.getElementById('subscription-key').value.trim();
            const serviceRegion = document.getElementById('service-region').value.trim();

            if (!subscriptionKey || !serviceRegion) {
                alert('Please enter both the subscription key and service region.');
                return;
            }

            // Save to localStorage
            localStorage.setItem('azureSubscriptionKey', subscriptionKey);
            localStorage.setItem('azureServiceRegion', serviceRegion);

            alert('Settings saved successfully.');

            // Update Settings button visibility
            updateSettingsButtonVisibility();

            // Navigate back to the review page after saving
            showPage('review-page');
        }

        // Load Settings on Page Load
        // Load Settings on Page Load
        function loadSettings() {
            const storedKey = localStorage.getItem('azureSubscriptionKey');
            const storedRegion = localStorage.getItem('azureServiceRegion');

            if (storedKey && storedRegion) {
                // If settings are already saved, do nothing or provide feedback
                console.log('Azure settings loaded from localStorage.');
            } else {
                // If settings are not saved, navigate to the settings page
                showPage('settings-page');
            }

            // Update Settings button visibility
            updateSettingsButtonVisibility();
        }


        function showPage(pageId) {
            const pages = ['input-page', 'review-page', 'status-page', 'import-export', 'settings-page'];
            
            // Hide all pages
            pages.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });

            // Show the selected page
            document.getElementById(pageId).style.display = 'block';

            // Call relevant functions based on the page
            if (pageId === 'review-page') {
                prepareReview();
            } else if (pageId === 'status-page') {
                updateStatus();
            } else if (pageId === 'input-page') {
                updateFlashcardList();
            }
        }

        // Process Flashcards Input
        function processFlashcards() {
            const inputText = document.getElementById('flashcard-input').value;
            const cards = parseFlashcards(inputText);

            cards.forEach(card => {
                if (!flashcards.some(fc => fc.prompt === card.prompt)) {
                    flashcards.push(card);
                }
            });

            document.getElementById('flashcard-input').value = '';
            localStorage.setItem('flashcards', JSON.stringify(flashcards));
            updateFlashcardList();
        }


        // Show Answers Function with Server-Side TTS
        function showAnswers() {
            const card = flashcards[currentReviewIndex];
            
            if (!card) {
                alert('No flashcard available to show the answer.');
                return;
            }

            const formattedAnswer = formatAnswer(card.answer);

            // Retrieve Azure settings from localStorage
            const subscriptionKey = localStorage.getItem('azureSubscriptionKey');
            const serviceRegion = localStorage.getItem('azureServiceRegion');

            if (!subscriptionKey || !serviceRegion) {
                alert('Azure settings are not configured. Please set them in the Settings page.');
                showPage('settings-page');
                return;
            }

            // Initialize Azure Speech Config
            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(subscriptionKey, serviceRegion);
            speechConfig.speechSynthesisVoiceName = voiceName;

            // Create a synthesizer
            const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, null);

            // Synthesize speech asynchronously
            synthesizer.speakTextAsync(card.answer,
                function (result) {
                    if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                        console.log('Speech synthesis succeeded.');
                    } else {
                        console.error('Speech synthesis failed:', result.errorDetails);
                    }
                    synthesizer.close();
                },
                function (err) {
                    console.error('Speech synthesis error:', err);
                    synthesizer.close();
                });

            // Populate the flashcard-answer div with the formatted answer
            document.getElementById('flashcard-answer').innerHTML = `
                ${formattedAnswer}
            `;

            // Show the answer and review buttons
            document.getElementById('flashcard-answer').classList.remove('hidden');
            document.getElementById('review-buttons').classList.remove('hidden');

            // Hide the "Show Answers" button
            document.getElementById('show-answers-button').classList.add('hidden');
        }


        function playPromptAudio() {
            const card = flashcards[currentReviewIndex];
            const playButton = document.getElementById('play-prompt-button');

            if (!card) {
                alert('No flashcard available to play the prompt.');
                return;
            }

            const promptText = card.prompt;

            // Retrieve Azure settings from localStorage
            const subscriptionKey = localStorage.getItem('azureSubscriptionKey');
            const serviceRegion = localStorage.getItem('azureServiceRegion');

            if (!subscriptionKey || !serviceRegion) {
                alert('Azure settings are not configured. Please set them in the Settings page.');
                showPage('settings-page');
                return;
            }

            // Disable the button to prevent multiple clicks
            playButton.disabled = true;
            playButton.innerText = 'Playing...';

            try {
                // Initialize Azure Speech Config
                const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(subscriptionKey, serviceRegion);
                speechConfig.speechSynthesisVoiceName = voiceName;

                // Create an audio configuration that outputs to the default speaker
                const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();

                // Create a synthesizer
                const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);

                // Synthesize speech and play audio
                synthesizer.speakTextAsync(promptText,
                    function (result) {
                        if (result.reason === SpeechSDK.ResultReason.SynthesizingAudioCompleted) {
                            console.log('Speech synthesis succeeded.');
                        } else {
                            console.error('Speech synthesis failed:', result.errorDetails);
                            alert('Failed to synthesize speech: ' + result.errorDetails);
                        }
                        synthesizer.close();
                        playButton.disabled = false;
                        playButton.innerText = 'Display';
                    },
                    function (err) {
                        console.error('Speech synthesis error:', err);
                        alert('Error during speech synthesis: ' + err);
                        synthesizer.close();
                        playButton.disabled = false;
                        playButton.innerText = 'Display';
                    });
            } catch (error) {
                console.error('Error initializing Speech SDK:', error);
                alert('Failed to initialize speech synthesis: ' + error);
                playButton.disabled = false;
                playButton.innerText = 'Display';
            }
        }

        // Parse Flashcards from Input Text


       // Update Flashcard List with Search Functionality and Styled Cards
        // Update Flashcard List with Formatted Answers on Input Page
        function updateFlashcardList() {
            const listDiv = document.getElementById('flashcard-list');
            listDiv.innerHTML = '';
            
            const searchQuery = document.getElementById('search-bar').value.toLowerCase();

            // Map flashcards to include their indices in the main array
            const filteredFlashcards = flashcards.map((card, index) => ({ card, index }))
                .filter(item => item.card.prompt.toLowerCase().includes(searchQuery));

            filteredFlashcards.forEach((item) => {
                const index = item.index;
                const card = item.card;
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-container';
                cardDiv.id = `flashcard-${index}`;
                
                // Format the answer using the existing formatAnswer function
                const formattedAnswer = formatAnswer(card.answer);

                // Retrieve and format audio and image if available
                let audioHTML = '';
                if (card.audio) {
                    const audioData = localStorage.getItem('audio_' + card.audio);
                    if (audioData) {
                        audioHTML = `<audio controls src="${audioData}"></audio>`;
                    }
                }

                let imageHTML = '';
                if (card.image) {
                    const imageData = localStorage.getItem('image_' + card.image);
                    if (imageData) {
                        imageHTML = `<img src="${imageData}" alt="Image">`;
                    }
                }

                // Display Mode with Formatted Answer and Media
                cardDiv.innerHTML = `
                    <div class="flashcard-content">
                        <div id="flashcard-prompt-${index}">
                            <strong>Prompt:</strong> ${card.prompt}
                        </div>
                        <div id="flashcard-answer-${index}">
                            <strong>Answer:</strong>
                            ${formattedAnswer}
                            ${audioHTML}
                            ${imageHTML}
                        </div>
                        <div class="card-footer">
                            <button onclick="enableEdit(${index})">Edit</button>
                            <button onclick="removeFlashcard(${index})">Remove</button>
                        </div>
                    </div>
                `;
                listDiv.appendChild(cardDiv);
            });
        }

        // Enable Edit Mode for a Specific Flashcard
        // Enable Edit Mode for a Specific Flashcard
        // Enable Edit Mode for a Specific Flashcard
        function enableEdit(index) {
            const card = flashcards[index];
            const cardDiv = document.getElementById(`flashcard-${index}`);
            cardDiv.innerHTML = ''; // Clear the cardDiv
            
            const flashcardContentDiv = document.createElement('div');
            flashcardContentDiv.className = 'flashcard-content';
            
            const promptLabel = document.createElement('label');
            promptLabel.textContent = 'Prompt:';
            flashcardContentDiv.appendChild(promptLabel);
            
            const promptInput = document.createElement('input');
            promptInput.type = 'text';
            promptInput.value = card.prompt;
            promptInput.style.cssText = 'width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid var(--light-blue); border-radius: 0.25rem;';
            flashcardContentDiv.appendChild(promptInput);
            
            const answerLabel = document.createElement('label');
            answerLabel.textContent = 'Answer:';
            flashcardContentDiv.appendChild(answerLabel);
            
            // Adjust the number of rows and style for the answer textarea
            const answerTextarea = document.createElement('textarea');
            answerTextarea.rows = 10; // Increase the number of rows from 4 to 10
            answerTextarea.value = card.answer;
            answerTextarea.style.cssText = `
                width: 100%;
                padding: 0.5rem;
                border: 1px solid var(--light-blue);
                border-radius: 0.25rem;
                min-height: 200px; /* Set a minimum height */
                resize: vertical;  /* Allow vertical resizing */
            `;
            flashcardContentDiv.appendChild(answerTextarea);
            
            const cardFooterDiv = document.createElement('div');
            cardFooterDiv.className = 'card-footer';
            
            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.addEventListener('click', function() {
                const updatedPrompt = promptInput.value.trim();
                const updatedAnswer = answerTextarea.value.trim();

                if (!updatedPrompt || !updatedAnswer) {
                    alert('Prompt and Answer cannot be empty.');
                    return;
                }

                // Update the flashcard data
                flashcards[index].prompt = updatedPrompt;
                flashcards[index].answer = updatedAnswer;
                flashcards[index].inputDate = new Date().toISOString().split('T')[0]; // Update input date if needed

                // Save to localStorage
                localStorage.setItem('flashcards', JSON.stringify(flashcards));

                // Refresh the flashcard list
                updateFlashcardList();
            });
            
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.addEventListener('click', function() {
                // Simply refresh the flashcard list to revert changes
                updateFlashcardList();
            });
            
            cardFooterDiv.appendChild(saveButton);
            cardFooterDiv.appendChild(cancelButton);
            flashcardContentDiv.appendChild(cardFooterDiv);
            cardDiv.appendChild(flashcardContentDiv);
        }

        // Save Edited Flashcard
        function saveEdit(index) {
            const updatedPrompt = document.getElementById(`prompt-${index}`).value.trim();
            const updatedAnswer = document.getElementById(`answer-${index}`).value.trim();

            if (!updatedPrompt || !updatedAnswer) {
                alert('Prompt and Answer cannot be empty.');
                return;
            }

            // Update the flashcard data
            flashcards[index].prompt = updatedPrompt;
            flashcards[index].answer = updatedAnswer;
            flashcards[index].inputDate = new Date().toISOString().split('T')[0]; // Update input date if needed

            // Save to localStorage
            localStorage.setItem('flashcards', JSON.stringify(flashcards));

            // Refresh the flashcard list
            updateFlashcardList();
        }


        // Cancel Editing of Flashcard
        function cancelEdit(index) {
            // Simply refresh the flashcard list to revert changes
            updateFlashcardList();
        }

        // Edit Flashcard
        function editFlashcard(index, field, value) {
            flashcards[index][field] = value;
            localStorage.setItem('flashcards', JSON.stringify(flashcards));
        }

        // Remove Flashcard
        function removeFlashcard(index) {
            flashcards.splice(index, 1);
            localStorage.setItem('flashcards', JSON.stringify(flashcards));
            updateFlashcardList();
        }

        // Load Flashcards on Page Load
        window.onload = function() {
            const storedFlashcards = localStorage.getItem('flashcards');
            if (storedFlashcards) {
                flashcards = JSON.parse(storedFlashcards);
            }

            // Load settings
            loadSettings();

            // Show the review page by default
            showPage('review-page');
        };

        // Prepare for Review
        function prepareReview() {
            const today = new Date().toISOString().split('T')[0];
            const dueFlashcards = flashcards.filter(card => card.nextReviewDate && card.nextReviewDate <= today);
            document.getElementById('flashcards-to-review').innerText = dueFlashcards.length;

            if (dueFlashcards.length > 0) {
                currentReviewIndex = flashcards.indexOf(dueFlashcards[0]);
                showFlashcardPrompt();
            } else {
                document.getElementById('flashcard-prompt').innerHTML = '<p>No flashcards to review today.</p>';
                document.getElementById('review-buttons').style.display = 'none';
                document.getElementById('flashcard-answer').classList.add('hidden');
            }
        }

        // Show Flashcard Prompt
        // Show Flashcard Prompt
        function showFlashcardPrompt() {
            const card = flashcards[currentReviewIndex];
            document.getElementById('flashcard-prompt').innerHTML = `<h3>${card.prompt}</h3>`;
            
            // Hide the answer and review buttons using the 'hidden' class
            document.getElementById('flashcard-answer').classList.add('hidden');
            document.getElementById('review-buttons').classList.add('hidden');
            
            // Show the "Show Answers" button
            document.getElementById('show-answers-button').classList.remove('hidden');
        }

        // Handle Review Choice
        // Handle Review Choice
        function reviewChoice(choice) {
            const card = flashcards[currentReviewIndex];
            const today = new Date().toISOString().split('T')[0];

            if (choice === 'remember') {
                card.rememberedCount += 1;

                // Determine the base date for the next interval
                let baseDate = new Date(today);
                if (card.nextReviewDate) {
                    const scheduledDate = new Date(card.nextReviewDate);
                    if (scheduledDate > baseDate) {
                        baseDate = scheduledDate;
                    }
                }

                if (card.group === 'A') {
                    const intervals = [1, 3, 7, 14, 30, 60];
                    const idx = Math.min(card.rememberedCount - 1, intervals.length - 1);
                    const nextInterval = intervals[idx];

                    card.nextReviewDate = addDays(baseDate, nextInterval);

                    if (card.rememberedCount >= intervals.length) {
                        card.nextReviewDate = null; // No longer needs review
                    }
                } else if (card.group === 'B') {
                    const nextInterval = 14; // Fixed interval for Group B

                    if (card.rememberedCount >= 2) {
                        card.nextReviewDate = null; // No longer needs review
                    } else {
                        card.nextReviewDate = addDays(baseDate, nextInterval);
                    }
                }
            } else {
                // Choice is 'forget' or 'not_sure'
                card.rememberedCount = 0;
                card.nextReviewDate = addDays(new Date(today), 1); // Review again tomorrow
            }

            card.reviewDates.push(today);
            localStorage.setItem('flashcards', JSON.stringify(flashcards));

            // Automatically move to the next flashcard
            prepareReview();
        }

        // Format the Answer for Display
        function formatAnswer(answer) {
            let formattedAnswer = '';
            const lines = answer.split('\n');
            let examples = '';
            lines.forEach(line => {
                if (line.startsWith('- **E')) {
                    examples += `<li>${line.substring(2)}</li>`;
                } else if (line.startsWith('- **Synonyms**:')) {
                    formattedAnswer += `<p><strong>Synonyms:</strong> ${line.substring(15)}</p>`;
                } else if (line.startsWith('- **Mnemonic**:')) {
                    formattedAnswer += `<p><strong>Mnemonic:</strong> ${line.substring(15)}</p>`;
                } else if (line.startsWith('- ')) {
                    formattedAnswer += `<p>${line.substring(2)}</p>`;
                } else {
                    formattedAnswer += `<p>${line}</p>`;
                }
            });
            if (examples) {
                formattedAnswer += `<p><strong>Examples:</strong></p><ul>${examples}</ul>`;
            }
            return formattedAnswer;
        }

        // Show Flashcard Answer
        // Show Flashcard Answer
        function showFlashcardAnswer() {
            const card = flashcards[currentReviewIndex];
            let audioHTML = '';
            if (card.audio) {
                const audioData = localStorage.getItem('audio_' + card.audio);
                if (audioData) {
                    audioHTML = `<audio controls src="${audioData}"></audio>`;
                }
            }
            let imageHTML = '';
            if (card.image) {
                const imageData = localStorage.getItem('image_' + card.image);
                if (imageData) {
                    imageHTML = `<img src="${imageData}" alt="Image">`;
                }
            }
            const formattedAnswer = formatAnswer(card.answer);
            document.getElementById('flashcard-answer').innerHTML = `
                ${formattedAnswer}
                ${audioHTML}
                ${imageHTML}
                <br>
                <button onclick="editCurrentFlashcard()">Edit</button>
                <button onclick="nextFlashcard()">Next Flashcard</button>
            `;
            document.getElementById('flashcard-answer').classList.remove('hidden');
            
            // Hide the review buttons using the 'hidden' class instead of style.display
            document.getElementById('review-buttons').classList.add('hidden');
        }


        function addDays(dateInput, days) {
            const date = new Date(dateInput);
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        }
        
        // Edit Current Flashcard in Review Page
        function editCurrentFlashcard() {
            const card = flashcards[currentReviewIndex];
            document.getElementById('flashcard-answer').innerHTML = `
                <p><strong>Prompt:</strong></p>
                <input type="text" value="${card.prompt}" onchange="editFlashcard(${currentReviewIndex}, 'prompt', this.value)">
                <p><strong>Answer:</strong></p>
                <textarea rows="5" onchange="editFlashcard(${currentReviewIndex}, 'answer', this.value)">${card.answer}</textarea>
                <p><strong>Audio:</strong> ${card.audio}</p>
                <label>Upload Audio:</label>
                <input type="file" accept="audio/*" onchange="uploadAudio(${currentReviewIndex}, this.files[0])">
                <p><strong>Image:</strong> ${card.image}</p>
                <label>Upload Image:</label>
                <input type="file" accept="image/*" onchange="uploadImage(${currentReviewIndex}, this.files[0])">
                <button onclick="saveEdit()">Save</button>
                <button onclick="cancelEdit()">Cancel</button>
            `;
        }

        function saveEdit() {
            localStorage.setItem('flashcards', JSON.stringify(flashcards));
            showFlashcardAnswer();
        }

        function cancelEdit() {
            showFlashcardAnswer();
        }

        // Move to Next Flashcard
        function nextFlashcard() {
            prepareReview();
        }

        // Add Days to Date
        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result.toISOString().split('T')[0];
        }

        // Update Status
        function updateStatus() {
            const statusDiv = document.getElementById('status-gallery');
            statusDiv.innerHTML = '';

            // Calculate summary
            const summary = {};
            groups.forEach(group => {
                summary[group] = { input: 0, waitForReview: 0, solidRemember: 0 };
            });

            flashcards.forEach(card => {
                summary[card.group].input += 1;
                if (card.nextReviewDate === null) {
                    summary[card.group].solidRemember += 1;
                } else {
                    summary[card.group].waitForReview += 1;
                }
            });

            // Display summary
            let summaryHTML = '<h3>Summary</h3><div class="status-row">';
            for (let group of groups) {
                summaryHTML += `
                    <div class="status-item">
                        <p><strong>Group ${group}</strong></p>
                        <p>Input: ${summary[group].input}</p>
                        <p>Wait for review: ${summary[group].waitForReview}</p>
                        <p>Solid remember: ${summary[group].solidRemember}</p>
                    </div>
                `;
            }
            summaryHTML += '</div>';
            statusDiv.innerHTML += summaryHTML;

            // Group by date
            const dates = {};
            flashcards.forEach(card => {
                const date = card.inputDate;
                if (!dates[date]) {
                    dates[date] = {};
                    groups.forEach(group => {
                        dates[date][group] = { input: 0, waitForReview: 0, solidRemember: 0 };
                    });
                }
                dates[date][card.group].input += 1;
                if (card.nextReviewDate === null) {
                    dates[date][card.group].solidRemember += 1;
                } else {
                    dates[date][card.group].waitForReview += 1;
                }
            });

            // Display date-wise stats
            const sortedDates = Object.keys(dates).sort().reverse();
            sortedDates.forEach(date => {
                let dateHTML = `<h3>${date}</h3><div class="status-row">`;
                for (let group of groups) {
                    const data = dates[date][group];
                    dateHTML += `
                        <div class="status-item">
                            <p><strong>Group ${group}</strong></p>
                            <p>Input: ${data.input}</p>
                            <p>Wait for review: ${data.waitForReview}</p>
                            <p>Solid remember: ${data.solidRemember}</p>
                        </div>
                    `;
                }
                dateHTML += '</div>';
                statusDiv.innerHTML += dateHTML;
            });
        }

        // Export Data
        function exportData() {
            const dataStr = JSON.stringify(flashcards);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = 'flashcards_data.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Import Data
        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                flashcards = JSON.parse(e.target.result);
                localStorage.setItem('flashcards', JSON.stringify(flashcards));
                updateFlashcardList();
                alert('Data imported successfully.');
            };
            reader.readAsText(file);
        }

        // Clear Cache
        function clearCache() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                localStorage.clear();
                flashcards = [];
                audioFiles = {};
                imageFiles = {};
                updateFlashcardList();
                alert('All data has been cleared.');
                showPage('input-page');
            }
        }
    </script>
</body>
</html>
